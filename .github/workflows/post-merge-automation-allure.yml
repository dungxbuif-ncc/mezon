name: Post-Merge Automation Tests with Allure

on:
  workflow_dispatch:

concurrency:
  group: automation-tests-allure-${{ github.workflow }}
  cancel-in-progress: false

jobs:
  automation-tests-with-allure:
    runs-on: mezon-e2e
    
    steps:
      - name: Checkout mezon-automation repository
        uses: actions/checkout@v4
        with:
          repository: ${{ github.repository_owner }}/mezon-automation
          path: mezon-automation
          token: ${{ secrets.PERSONAL_TOKEN }}

      - name: Install mezon-automation dependencies
        working-directory: ./mezon-automation
        run: yarn

      - name: Install Playwright browsers
        working-directory: ./mezon-automation
        run: npx playwright install

      - name: Create environment file
        working-directory: ./mezon-automation
        run: |
          cat > .env << EOF
          BASE_URL=https://dev-mezon.nccsoft.vn
          SKIP_LOGIN=true
          WORKERS=1
          EOF

      - name: Verify dev environment is accessible
        run: |
          echo "ğŸŒ Testing connection to dev-mezon.nccsoft.vn..."
          curl -s --head https://dev-mezon.nccsoft.vn > /dev/null || {
            echo "âŒ Cannot reach https://dev-mezon.nccsoft.vn"
            exit 1
          }
          echo "âœ… Dev environment is accessible!"

      - name: Prepare Allure history
        working-directory: ./mezon-automation
        run: |
          echo "ğŸ”§ Preparing Allure history and directories..."
          
          # Ensure allure-results directory exists locally
          mkdir -p allure-results
          
          # Check if global allure directory exists, create if not
          if [ ! -d "/home/dungxbuif/allure" ]; then
            echo "ğŸ“ Creating global allure directory..."
            sudo mkdir -p /home/dungxbuif/allure/allure-results
            sudo mkdir -p /home/dungxbuif/allure/allure-report
            sudo chown -R www-data:www-data /home/dungxbuif/allure
            sudo chmod -R 755 /home/dungxbuif/allure
            echo "âœ… Global allure directory created"
          fi
          
          # Copy previous allure-results from global allure directory to preserve history
          if [ -d "/home/dungxbuif/allure/allure-results" ] && [ "$(ls -A /home/dungxbuif/allure/allure-results 2>/dev/null)" ]; then
            echo "ğŸ“‚ Copying previous allure-results for history preservation..."
            cp -r /home/dungxbuif/allure/allure-results/* ./allure-results/ 2>/dev/null || echo "No previous results to copy"
          else
            echo "ğŸ“ No previous allure-results found, starting fresh"
          fi
          
          # Copy previous history from global allure-report to allure-results (as per Allure docs)
          if [ -d "/home/dungxbuif/allure/allure-report/history" ] && [ "$(ls -A /home/dungxbuif/allure/allure-report/history 2>/dev/null)" ]; then
            echo "ğŸ“œ Preserving test history..."
            cp -r /home/dungxbuif/allure/allure-report/history ./allure-results/ 2>/dev/null || echo "Failed to copy history"
            echo "âœ… History preserved"
          else
            echo "ğŸ“ No previous test history found, starting fresh"
          fi

      - name: Run automation tests with Allure
        working-directory: ./mezon-automation
        run: npm run test
        continue-on-error: true

      - name: Generate Allure report
        if: always()
        working-directory: ./mezon-automation
        run: |
          echo "ğŸ“Š Generating Allure report..."
          npm run allure:generate || {
            echo "âš ï¸ Allure generation failed, trying with clean generation..."
            npx allure generate allure-results --clean -o allure-report --single-file
          }

      - name: Update global Allure directory
        if: always()
        working-directory: ./mezon-automation
        run: |
          echo "ğŸ”„ Updating global Allure directory..."
          
          # Ensure global allure directory exists
          if [ ! -d "/home/dungxbuif/allure" ]; then
            echo "ğŸ“ Creating global allure directory..."
            sudo mkdir -p /home/dungxbuif/allure
            sudo chown www-data:www-data /home/dungxbuif/allure
            sudo chmod 755 /home/dungxbuif/allure
          fi
          
          # Backup current global allure if it exists and has content
          if [ -d "/home/dungxbuif/allure/allure-report" ] && [ "$(ls -A /home/dungxbuif/allure/allure-report 2>/dev/null)" ]; then
            echo "ğŸ’¾ Backing up current allure report..."
            sudo cp -r /home/dungxbuif/allure/allure-report /home/dungxbuif/allure/allure-report.backup.$(date +%Y%m%d_%H%M%S) 2>/dev/null || echo "Backup failed, continuing..."
          else
            echo "ğŸ“ No existing allure report to backup"
          fi
          
          # Replace global allure-results with new ones
          if [ -d "allure-results" ] && [ "$(ls -A allure-results 2>/dev/null)" ]; then
            echo "ğŸ“ Updating allure-results..."
            sudo rm -rf /home/dungxbuif/allure/allure-results 2>/dev/null || true
            sudo cp -r allure-results /home/dungxbuif/allure/
            sudo chown -R www-data:www-data /home/dungxbuif/allure/allure-results
            sudo chmod -R 755 /home/dungxbuif/allure/allure-results
            echo "âœ… Allure results updated"
          else
            echo "âš ï¸ No allure-results to update"
          fi
          
          # Replace global allure-report with new ones
          if [ -d "allure-report" ] && [ "$(ls -A allure-report 2>/dev/null)" ]; then
            echo "ğŸ“Š Updating allure-report..."
            sudo rm -rf /home/dungxbuif/allure/allure-report 2>/dev/null || true
            sudo cp -r allure-report /home/dungxbuif/allure/
            sudo chown -R www-data:www-data /home/dungxbuif/allure/allure-report
            sudo chmod -R 755 /home/dungxbuif/allure/allure-report
            echo "âœ… Allure report updated"
          else
            echo "âš ï¸ No allure-report to update"
            # Create empty report directory if none exists
            if [ ! -d "/home/dungxbuif/allure/allure-report" ]; then
              echo "ğŸ“ Creating empty allure-report directory..."
              sudo mkdir -p /home/dungxbuif/allure/allure-report
              sudo chown www-data:www-data /home/dungxbuif/allure/allure-report
              sudo chmod 755 /home/dungxbuif/allure/allure-report
            fi
          fi
          
          echo "âœ… Global Allure directory updated successfully!"

      - name: Restart nginx to ensure proper serving
        if: always()
        run: |
          sudo systemctl reload nginx || sudo systemctl restart nginx
          echo "ğŸ”„ Nginx reloaded to serve new Allure report"

      - name: Upload artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: allure-results-${{ github.sha }}
          path: |
            mezon-automation/playwright-report/
          retention-days: 7


      - name: Cleanup old backups (keep last 5)
        if: always()
        run: |
          echo "ğŸ§¹ Cleaning up old Allure report backups..."
          
          # Ensure allure directory exists before cleanup
          if [ -d "/home/dungxbuif/allure" ]; then
            cd /home/dungxbuif/allure/
            
            # Count existing backups
            BACKUP_COUNT=$(sudo find . -name "allure-report.backup.*" -type d 2>/dev/null | wc -l)
            echo "ğŸ“Š Found $BACKUP_COUNT backup(s)"
            
            if [ "$BACKUP_COUNT" -gt 5 ]; then
              echo "ğŸ—‘ï¸ Removing old backups (keeping last 5)..."
              sudo find . -name "allure-report.backup.*" -type d -printf '%T@ %p\n' 2>/dev/null | sort -n | head -n -5 | cut -d' ' -f2- | sudo xargs rm -rf 2>/dev/null || echo "Cleanup completed with warnings"
              echo "âœ… Old backups cleaned up"
            else
              echo "âœ… No cleanup needed (â‰¤5 backups)"
            fi
          else
            echo "ğŸ“ No allure directory found, skipping cleanup"
          fi
          
          echo "âœ… Cleanup completed"
